<!DOCTYPE html>
<html manifest="todoist.manifest">
<head><title>Todoist</title>
<link rel="apple-touch-icon" href="http://static.todoist.com/96444e78b51b8496f2817e2b59ef915d.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=800,initial-scale=1.4">
<script>
function $(s) {
  return document.getElementById(s);
}

var todoist = {
  data: {},
  countdown: 0,
  projCount: 0,
  afterLogin: [],

  ajax: function(m, p) {
    var s = document.createElement("script");
    s.src = (m == "login" ? "https:/" : "http:/") 
      + "/todoist.com/API/" 
      + m 
      + "?&callback=todoist.cb" + m 
      + (this.token ? "&token=" + this.token : "") 
      + (p || "")
      + "&.rand=" + Math.random();
    document.getElementsByTagName("head")[0].appendChild(s);
  },

  cookie: function(n, v, remove) {
    var elm;
    try {
      if(window.localStorage) {
        if(remove) {
          localStorage.removeItem(n);
        } else if(v) {
          localStorage.setItem(n, encodeURIComponent(v));
        } else {
          return decodeURIComponent(localStorage.getItem(n) || "");
        }
        return;
      }
    } catch(e) {}

    if(remove) {
      document.cookie = encodeURIComponent(n) + "=; expires=Mon, 1 Jan 1980 01:01:01 GMT";
    } else if(v) {
      document.cookie = encodeURIComponent(n) + "=" + 
        encodeURIComponent(v) + "; expires=" + 
        new Date(new Date().getTime() + 30*24*60*60*1000).toGMTString();
    } else {
      var s = " " + document.cookie + ";";
      var i = s.indexOf(" " + n + "=");
      if(i >= 0) return decodeURIComponent(s.substring(s.indexOf("=", i) + 1, s.indexOf(";",i + 1)));
    }
  },

  onload: function() {
    var dis = this;
    this.transaction(function(t) {
      t.executeSql(
        "SELECT * FROM projs", [],
        function(t, r) {
          r = r.rows;
          if(r.length == 0) return dis.goOnline();
          for(var i=0; i<r.length; i++) dis.data[r.item(i).id] = {name: r.item(i).name, order:r.item(i).item_order};
        }
      );
      t.executeSql(
        "SELECT * FROM tasks", [],
        function(t, r) {
          r = r.rows;
          if(r.length == 0) return dis.goOnline();

          for(var i=0; i<r.length; i++) {
            var proj = dis.data[r.item(i).project_id];
            if(!proj.data) proj.data = [];

            var tmp = r.item(i).due_date;

            proj.data.push({
              id: r.item(i).id,
              project_id: r.item(i).project_id,
              content: r.item(i).content,
              due_date: tmp ? new Date(Date.UTC(tmp.substr(0,4), 1*tmp.substring(5,7)-1, tmp.substr(8), 23, 59, 59)) : null,
              priority: r.item(i).priority
            });
          }

          dis.projCount = 0;
          for(var i in dis.data) {
            if(dis.data[i].data) dis.projCount++;
          }
          dis.updateView();
        }
      );
    }, function(e) {
      dis.goOnline();
    });
  },

  goOnline: function() {
    if(this.token) {
      this.ajax("getProjects");
    } else if(!this.cookie("tduser") || !this.cookie("tdpass")) {
      $("loginbox").style.display = "block";
      $("loginnow").value = "Login";
      $("loginnow").disabled = false;
      window.scrollTo(0, 0);
    } else {
      this.login();
    }
  },

  login: function() {
      $("loginnow").value = "Loading...";
      $("loginnow").disabled = true;
      var u = encodeURIComponent(this.cookie("tduser") || $("user").value);
      var p = encodeURIComponent(this.cookie("tdpass") || $("pass").value);
      this.ajax("login", "&email="+u+"&password="+p);
  },

  cblogin: function(r) {
    $("loginnow").value = "Login";
    $("loginnow").disabled = false;
    if(typeof r == "string") {
      $("loginbox").style.display = "";
      alert("Error: "+r);
    } else {
      $("loginbox").style.display = "none";
      if($("user").value && $("savelogin").checked) this.cookie("tduser", $("user").value);
      if($("pass").value && $("savelogin").checked) this.cookie("tdpass", $("pass").value);

      this.token = r.api_token;

      var al = this.afterLogin;
      if(al.length) {
        for(var i=0; i<al.length; i++) {
          if(al[i]) this.ajax(al[i][0], al[i][1]);
        }
      } else {
        this.ajax("getProjects");
      }
    }
  },

  cbgetProjects: function(r) {
    this.projCount = 0;

    if(typeof r == "string") {
      alert("Error: "+r);
      this.token = null;
      this.goOnline();
    }

    for(var i=0; i<r.length; i++) {
      this.data[r[i].id] = {name: r[i].name, order: r[i].item_order||0};
      this.countdown++;
      this.ajax("getUncompletedItems", "&js_date=1&project_id=" + r[i].id);
    }

    var d = this.data;
    this.transaction(function(t) {
      t.executeSql("DELETE FROM projs");
      t.executeSql("DELETE FROM tasks");
      for(var i in d) {
        t.executeSql("INSERT INTO projs (id, name, item_order) VALUES (?, ?, ?)", [i, d[i].name, d[i].order]);
      }
    });
  },

  cbgetUncompletedItems: function(r) {
    this.countdown--;

    if(r && r.length) {
      this.data[r[0].project_id].data = r;
      this.projCount++;

      this.transaction(function(t) {  //used by addItem
        t.executeSql("DELETE FROM tasks WHERE project_id = ?", [r[0].project_id]);
      });
    }

    if(this.countdown == 0) this.updateView();

    if(r && r.length) {
      var d = this.data[r[0].project_id].data;

      this.transaction(function(t) {
        var tmp, pad = function(i) {return i < 10 ? "0" + i : i};

        for(var i=0; i<d.length; i++) {

          tmp = d[i].due_date;
          if(tmp) tmp = tmp.getUTCFullYear() + "-" + pad(tmp.getUTCMonth() + 1) + "-" + pad(tmp.getUTCDate());

          t.executeSql(
            "INSERT INTO tasks (id, project_id, content, due_date, priority) VALUES (?, ?, ?, ?, ?)", 
            [d[i].id, d[i].project_id, d[i].content, tmp, d[i].priority]
          );
        }
      });
    }
  },

  updateView: function() {
    var html = [];
    var width = Math.floor(97/(this.projCount||1));
    var item;
    var bullet;
    var now = new Date().getTime();

    var ie6width = document.all ? ";_width:expression(document.body.clientWidth/("+this.projCount+'||1)<160?"160px":"'+width+'%")' : "";

    var projs = [];  //sort projs
    for(var i in this.data) projs.push(i);
    var i = projs.length - 1;
    while(i >= 0) {
      var j = this.data[projs[i]].order;
      if(!j || i == j - 1) {
        i--;
      } else {
        var tmp = projs[i];
        projs[i] = projs[j-1];
        projs[j-1] = tmp;
      }
    }

    for(var i=0; i<projs.length; i++) {
      var proj = this.data[projs[i]];
      if(!proj.data) continue;

      for(var j=0; j<proj.data.length; j++) {
        item = proj.data[j];
        bullet = item.due_date ? item.due_date.getTime() - now : -1;
        item.due_now = bullet < 0 ? 0 : bullet < 60000*60*24 ? 2 : bullet < 60000*60*24*7 ? 1 : 0;
        if(item.due_now == 2) {
          proj.data.splice(j, 1);
          proj.data.unshift(item);
        }
      }

      html.push("<div class='proj' style='width:"+width+"%"+ie6width+"'><h2><a href='javascript:todoist.addItem("+projs[i]+");'>"+proj.name+"</a></h2><ul>");
      for(var j=0; j<proj.data.length; j++) {
        item = proj.data[j];

        bullet = item.due_now == 2 ? "bullnow'>&rArr;" : item.due_now == 1 ?  "bullweek'>&diams;" : "bullold'>&bull;";
        bullet = "<span class='" + bullet + "</span>";

        html.push("<li class='imp"+item.priority+(j%2?" alt":"")+"' onclick='todoist.completeItems("+item.id+","+projs[i]+",this);'>"+bullet+item.content+"<span class='due'>"+(item.due_date?(item.due_date.getMonth()+1)+"/"+item.due_date.getDate():"")+"</span></li>");
      }
      html.push("</ul></div>");
    }
    if(this.projCount == 0) html.push("List is empty.");
    $("main").innerHTML = html.join("");
    document.body.className = "flash";
    setTimeout(function() {document.body.className = "";}, 100);
  },

  addItem: function(id) {
    if(!this.token) {
      this.goOnline();
      this.afterLogin.push(null);
    }

    var s = prompt("What to add to '"+this.data[id].name+"'?", "");
    var ds = s ? prompt("Due when?", (new Date().getHours() < 18 ? "today" : "tomorrow")) : null;
    if(s) {
      if(this.token) {
        this.ajax("addItem", "&project_id="+id+"&priority=1&content="+encodeURIComponent(s)+(ds?"&date_string="+encodeURIComponent(ds):""));
      } else {
        this.afterLogin.push(["addItem", "&project_id="+id+"&priority=1&content="+encodeURIComponent(s)+(ds?"&date_string="+encodeURIComponent(ds):"")]);
      }
    }
  },

  cbaddItem: function(r) {
    if(typeof r == "string") {
      alert(r);
    } else {
      this.countdown++;
      this.projCount--;
      this.ajax("getUncompletedItems", "&js_date=1&project_id=" + r.project_id);
    }
  },

  completeItems: function(id, proj, n) {
    if(confirm("Item done?")) {
      if(this.token) {
        this.ajax("completeItems", "&ids=%5B" + id + "%5D");
      } else {
        this.afterLogin.push(["completeItems", "&ids=%5B" + id + "%5D"]);
        this.goOnline();
      }
      n.parentNode.removeChild(n);
      this.transaction(function(t) {
        t.executeSql("DELETE FROM tasks WHERE id = ?", [id]);
      });
    }
  },

  cbcompleteItems: function(r) {
  },

  logout: function() {
    this.transaction(function(t) {
      t.executeSql("DELETE FROM projs");
      t.executeSql("DELETE FROM tasks");
    });
    this.cookie("tduser", 0, 1);
    this.cookie("tdpass", 0, 1);
    $("user").value = "";
    $("pass").value = "";
    this.projCount = this.token = 0;
    this.data = {};
    this.updateView();
    this.goOnline();
  },

  transaction: function(a, b, c) {
    var f = new Function("");
    b = b || f;
    c = c || f;
    if(!this.dbms) {
      this.dbms = [[a, b, c]];
      var _dbms, dis = this;
      try {
        _dbms = window.openDatabase("todoist-dashboard", "1.0", "Tasks", 5*1024*1024);
        _dbms.transaction(
          function(t) {
            t.executeSql("CREATE TABLE IF NOT EXISTS tasks (id INTEGER, project_id INTEGER, content TEXT, due_date DATE, priority TINYINT)");
            t.executeSql("CREATE TABLE IF NOT EXISTS projs (id INTEGER, name TEXT, item_order INTEGER)");
          }, function(e) {
            dis.transaction = f;
            for(var i=0; i<dis.dbms.length; i++) dis.dbms[i][1](e);
          }, function() {  //ok
            for(var i=0; i<dis.dbms.length; i++) _dbms.transaction.apply(_dbms, dis.dbms[i]);
            dis.dbms = _dbms;
          }
        );
      } catch(e) {
        this.transaction = f;
        for(var i=0; i<this.dbms.length; i++) this.dbms[i][1](e);
      }
    } else if(this.dbms.transaction) {
      this.dbms.transaction(a, b, c);
    } else {
      this.dbms.push([a, b, c]);
    }
  }
}
</script>
<style>
body {font:9pt Helvetica,Arial; _font-weight:bold; margin:0; padding:0; background:#000; color:#fff; -webkit-text-size-adjust:none}
body.flash {background:#333}
.proj {float:left; min-width:160px; padding:0; box-sizing:border-box; -moz-box-sizing:border-box; -webkit-box-sizing:border-box}
.proj h2 {margin:0 0 0.3em 0; padding:0}
a {font-size:9pt; color:#fff}
.proj h2 a {font:bold 11pt Helvetica,Arial; text-decoration:none}
.due {color:#bbe; font-size:8pt; margin-left:4%}
ul,li {padding:3px 3px 1em 3px; margin:0; list-style:none; vertical-align:middle}
li {padding:0 0 0.15em 0.8em; text-indent:-0.8em; color:#ccc}
li.alt {color:#fff}
li.imp4 {color:#faa}
.bullnow, .bullweek, .bullold {color:#888; margin-right:0.3em; font-weight:bold} .bullnow {color:#aaa; margin-left:-0.5em} .bullweek {color:#aaa}
@media screen and (max-device-width: 480px) {body {width:1000px} #main {display:table-row} .proj {float:none; display:table-cell}}
</style>
</head>
<body style="overflow:auto">
<form id="loginbox" style="margin:5px;padding:0;display:none" onsubmit="todoist.login();return false;">
User:<br><input id="user" type="email"><noscript style="color:red">Please enable JavaScript to login.</noscript>
<br>Pass:<br><input id="pass" type="password">
<br><input type="submit" id="loginnow" value="Login"> <a href="http://todoist.com">Register</a>
<br><input type=checkbox id="savelogin">Save login as cookie
</form>
<div style="float:left; width:1%"><a href="#" onclick="todoist.goOnline();" style="padding:3px">R</a></div>
<div id="main"></div>
<div style="clear:both;padding-top:1em;font-size:8pt;color:#aaa">
<a href="#" onclick="this.style.display='none';this.nextSibling.style.display='';return false;" style="margin:3px">?</a><div style="display:none">
Todoist Wall -
<br>(1) click on project title to add a task
<br>(2) add website to home screen to remove Safari buttons
<br><a href="javascript:todoist.logout();window.scrollTo(0,0);">logout</a>
</div></div>
<script>todoist.onload();</script>
</body>
</html>